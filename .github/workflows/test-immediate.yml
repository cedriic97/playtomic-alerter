name: Test Immediate Sync

on:
  schedule:
    # Run every minute for testing (remove after testing)
    - cron: '* * * * *'
  
  # Manual trigger
  workflow_dispatch:

jobs:
  test-sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Test Immediate Sync
        run: |
          echo "üß™ Test sync at $(date) (UTC: $(date -u))"
          echo "Current hour UTC: $(date -u +%H)"
          echo "This is a test run to verify scheduling works"
          echo "üîó URL: ${{ secrets.SUPABASE_URL }}/functions/v1/sync-availability"
          
          response=$(curl -s -w "%{http_code}" -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/sync-availability" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-Test" \
            --max-time 300)
          
          http_code="${response: -3}"
          body="${response%???}"
          
          if [ "$http_code" != "200" ]; then
            echo "‚ùå Test sync failed with HTTP $http_code"
            exit 1
          fi
          
          success=$(echo "$body" | jq -r '.success // false')
          if [ "$success" != "true" ]; then
            echo "‚ùå Test sync returned success=false"
            exit 1
          fi
          
          sync_run_id=$(echo "$body" | jq -r '.syncRunId // ""')
          slots_found=$(echo "$body" | jq -r '.stats.slotsFound // 0')
          
          echo "‚úÖ Test sync successful!"
          echo "üìä Run: ${sync_run_id:0:8}... | Slots: $slots_found"
          echo "üéØ Scheduling is working - remove this workflow after verification"