name: Sync Court Availability

on:
  schedule:
    # L√§uft alle 30 Minuten (optimal f√ºr Cancellation Detection)
    - cron: '*/30 * * * *'
  
  # Erm√∂glicht manuelles Triggern √ºber GitHub UI
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Trigger Supabase Edge Function
        run: |
          echo "‚è∞ Starting scheduled sync at $(date)"
          echo "üîó URL: ${{ secrets.SUPABASE_URL }}/functions/v1/sync-availability"
          
          response=$(curl -s -w "%{http_code}" -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/sync-availability" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions" \
            --max-time 120)
          
          http_code="${response: -3}"
          body="${response%???}"
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          # Pr√ºfe auf Erfolg
          if [ "$http_code" != "200" ]; then
            echo "‚ùå Sync failed with HTTP $http_code"
            exit 1
          fi
          
          # Pr√ºfe JSON Response auf Erfolg
          success=$(echo "$body" | jq -r '.success // false')
          if [ "$success" != "true" ]; then
            echo "‚ùå Sync returned success=false"
            echo "$body" | jq '.'
            exit 1
          fi
          
          # Zeige Stats
          echo "‚úÖ Sync successful!"
          echo "$body" | jq '{
            syncRunId: .syncRunId,
            clubsSynced: .stats.clubsSynced,
            slotsFound: .stats.slotsFound,
            slotsUpdated: .stats.slotsUpdated,
            cancellationsDetected: .stats.cancellationsDetected,
            errors: .stats.errors
          }'
          
          # Warnung bei Cancellations
          cancellations=$(echo "$body" | jq -r '.stats.cancellationsDetected // 0')
          if [ "$cancellations" -gt "0" ]; then
            echo "üéæ $cancellations neue Cancellations entdeckt!"
          fi