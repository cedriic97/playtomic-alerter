name: Debug Sync

on:
  workflow_dispatch:
    inputs:
      debug_level:
        description: 'Debug level (1-3)'
        required: false
        default: '2'

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
      - name: Debug Environment
        run: |
          echo "üîç Debug Information"
          echo "Current time: $(date)"
          echo "GitHub Actor: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
          
      - name: Check Secrets (masked)
        run: |
          echo "üîê Checking secrets availability..."
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "‚ùå SUPABASE_URL secret is missing"
            exit 1
          else
            echo "‚úÖ SUPABASE_URL secret exists"
            echo "URL starts with: $(echo '${{ secrets.SUPABASE_URL }}' | cut -c1-20)..."
          fi
          
          if [ -z "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
            echo "‚ùå SUPABASE_SERVICE_ROLE_KEY secret is missing"  
            exit 1
          else
            echo "‚úÖ SUPABASE_SERVICE_ROLE_KEY secret exists"
            echo "Key starts with: $(echo '${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}' | cut -c1-20)..."
          fi
          
      - name: Test Network Connectivity
        run: |
          echo "üåê Testing network connectivity..."
          
          # Test basic connectivity to Supabase
          base_url=$(echo "${{ secrets.SUPABASE_URL }}" | cut -d'/' -f1-3)
          echo "Testing connectivity to: $base_url"
          
          curl -I --max-time 30 "$base_url" || echo "‚ùå Base URL not reachable"
          
      - name: Test Edge Function with Verbose Output
        run: |
          echo "üöÄ Testing Edge Function..."
          
          # Full URL
          FUNCTION_URL="${{ secrets.SUPABASE_URL }}/functions/v1/sync-availability"
          echo "Full URL: $FUNCTION_URL"
          
          # Test with verbose output
          curl -v --max-time 120 \
            -X POST "$FUNCTION_URL" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-Debug" \
            -o response.txt \
            -w "HTTP Status: %{http_code}\nTotal time: %{time_total}s\n" || echo "‚ùå Curl failed"
          
          echo "üìÑ Response content:"
          cat response.txt || echo "No response file"
          
      - name: Alternative Test (GET request)
        run: |
          echo "üîÑ Testing with GET request..."
          
          curl -v --max-time 30 \
            -X GET "${{ secrets.SUPABASE_URL }}/functions/v1/" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -w "HTTP Status: %{http_code}\n" || echo "‚ùå GET test failed"