name: Manual Sync (On-Demand)

on:
  # Nur manuelles Triggern Ã¼ber GitHub UI oder API
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual sync'
        required: false
        default: 'Manual trigger'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Manual Sync Trigger
        run: |
          echo "ğŸš€ Manual sync triggered: ${{ github.event.inputs.reason }}"
          
      - name: Trigger Supabase Edge Function and Wait for Completion
        run: |
          echo "â° Starting sync at $(date)"
          echo "ğŸ”— URL: ${{ secrets.SUPABASE_URL }}/functions/v1/sync-availability"
          
          # Call the Edge Function
          response=$(curl -s -w "%{http_code}" -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/sync-availability" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions" \
            --max-time 300)
          
          http_code="${response: -3}"
          body="${response%???}"
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" != "200" ]; then
            echo "âŒ Sync failed with HTTP $http_code"
            exit 1
          fi
          
          success=$(echo "$body" | jq -r '.success // false')
          if [ "$success" != "true" ]; then
            echo "âŒ Sync returned success=false"
            exit 1
          fi
          
          # Extract sync run details
          sync_run_id=$(echo "$body" | jq -r '.syncRunId // ""')
          echo "ğŸ“Š Sync Run ID: $sync_run_id"
          
          # Display immediate results
          echo "âœ… Sync completed successfully!"
          echo "$body" | jq -r '
            "ğŸ¢ Clubs Synced: \(.stats.clubsSynced // 0)",
            "ğŸ¾ Slots Found: \(.stats.slotsFound // 0)", 
            "ğŸ“ Slots Updated: \(.stats.slotsUpdated // 0)",
            "ğŸš¨ Cancellations: \(.stats.cancellationsDetected // 0)",
            "âš ï¸  Errors: \(.stats.errors | length)"
          '
          
          if [ "$(echo "$body" | jq -r '.stats.errors | length')" != "0" ]; then
            echo "âŒ Errors occurred:"
            echo "$body" | jq -r '.stats.errors[]'
          fi
          
          # Show final summary
          echo ""
          echo "ğŸ“ˆ Summary:"
          echo "$body" | jq '{
            syncRunId: .syncRunId,
            message: .message,
            timestamp: .timestamp,
            stats: .stats
          }'